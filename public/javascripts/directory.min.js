function log(a){console.log(a)}function setFilterDisplay(a){var b=getScope();a.push({name:"Región",value:b.region==1e3?"Todas":b.region==100?"España":"Aragón"}),b.freelance&&a.push({name:"Freelance",value:"SI"}),b.entrepreneur&&a.push({name:"Emprendedor",value:"SI"}),viewModel.filter(a)}function friendly_url(a){return a.toLowerCase().replace(/^\s+|\s+$/g,"").replace(/[_|\s]+/g,"-").replace(/[^a-z0-9-]+/g,"").replace(/[-]+/g,"-").replace(/^-+|-+$/g,"").replace(new RegExp("[àáâãäå]","g"),"a").replace(new RegExp("[èéêë]","g"),"e").replace(new RegExp("[ìíîï]","g"),"i").replace(new RegExp("[òóôõö]","g"),"o").replace(new RegExp("[ùúûü]","g"),"u")}function getScope(){var a={};return a.freelance=$("#freelance_scope").is(":checked")?!0:!1,a.entrepreneur=$("#entrepreneur_scope").is(":checked")?!0:!1,$("#worldwide_scope").is(":checked")?a.region=1e3:$("#national_scope").is(":checked")?a.region=100:$("#regional_scope").is(":checked")?a.region=10:a.region=1e3,a}function set_content_by_hash(a,b){var c={};$.address.parameter("p")&&(c.from=$.address.parameter("p"));if(a.indexOf("/search")==0)c.search=decodeURIComponent(a.split("/")[2]),$("#searchBox").val(c.search),directory.search(c,function(a,c,d){$(document).trigger("directory.onProfessionalListChanged",d),$(document).trigger("directory.onSearchCompleted",d.search),b&&b()});else if(a.indexOf("/user")==0){var d=a.split("/")[2],e=$("#profile"+d);if(e.length){var f=viewModel.get_user_from_ViewModel(d);f&&renderProfile(f,function(a,c){$(document).trigger("directory.onProfileLoaded",f),b&&b()})}else directory.load_profile(d,function(a,c){directory.load_data({id_cat:c.cats[0],bindusers:!1,bindtags:!1},function(a,d){viewModel.bindprofessionals([c]),viewModel.tags(d.tags),renderProfile(viewModel.professionals()[0],function(a,d){$(document).trigger("directory.onProfileLoaded",c),b&&b()})})})}else{var g=/\/categories\/(.*)\/(.*)\/tag\/(.*)/,h=/\/categories\/(.*)\/(.*)/,i=/\/tags\/(.*)/;if(a.match(g)){var j=a.match(g);c.id_cat=j[1],c.tag=decodeURIComponent(j[3])}else if(a.match(h)){var j=a.match(h);c.id_cat=j[1],c.tag=null}else if(a.match(i)){var j=a.match(i);c.tag=decodeURIComponent(j[1])}else c.id_cat=1;c.sort=$("#sortingSelect").val(),directory.load_data(c,function(a,c,d){$(document).trigger("directory.onProfessionalListChanged",d),b&&b()})}}function getGitHubProjects(a,b){var c="github "+a;$("body").data(c)?$(b).html($("body").data(c)):($(b).html(loading),$.getJSON("https://api.github.com/users/"+a+"/repos?callback=?",function(a){function f(a,b){return b.watchers-a.watchers}var d=[];for(var e=0;e<a.data.length;e++)a.data[e].fork||d.push(a.data[e]);d.sort(f);if(d.length){var g="<ul>";for(var e=0,h=0;h<5&&e<d.length;e++)g=g+'<li><a title="watchers" target=_blank href="'+d[e].html_url+'/watchers">'+d[e].watchers+"</a>"+' / <a title="forks" target=_blank href="'+d[e].html_url+'/network">'+d[e].forks+"</a>"+' - <a target=_blank href="'+d[e].html_url+'">'+d[e].name+"</a>: "+d[e].description+"</li>",h++;g+="</ul>"}else g="<p>No se han encontrado proyectos propios públicos.</p>";$(b).html(g),$("body").data(c,g)}))}function replaceURLWithHTMLLinks(a){var b=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return a.replace(b,"<a target=_blank href='$1'>$1</a>")}function replaceTwText(a){return replaceURLWithHTMLLinks(a)}function getTwTimeline(a,b,c){if($("body").data(a)){var d=$("body").data(a);$(b).html(d),$("abbr.timeago").timeago(),c&&c(null,d)}else $(b).html(loading),$.getJSON("http://twitter.com/status/user_timeline/"+a+".json?count=50&callback=?&exclude_replies=true&trim_user=true&include_rts=false",{cache:!0},function(d,e){var f="<ul>";for(var g=0,h=0;h<5&&g<d.length;g++)d[g].in_reply_to_user_id||(f=f+'<li><abbr class="timeago" title="'+d[g].created_at+'">'+d[g].created_at+"</abbr> "+replaceTwText(d[g].text)+"</li>",h++);f+="</ul>",$(b).html(f),c&&c(null,f),$("abbr.timeago").timeago(),$("body").data(a,f)})}function renderProfile(a,b){a.expanded(!0),a.twitter&&getTwTimeline(a.twitter(),$("#profile"+a.id()+" .tw_timeline")),a.github&&getGitHubProjects(a.github(),$("#profile"+a.id()+" .github_projects")),b&&b(null,a)}var viewModel={logged_user:ko.observable(),professionals:ko.observableArray(),tags:ko.observableArray(),cats:ko.observableArray(),filter:ko.observableArray(),bindprofessionals:function(a){for(var b=0;b<a.length;b++)a[b].expanded=!1,a[b].friendlyurlname=friendly_url(a[b].name);this.professionals=ko.mapping.fromJS(a),ko.applyBindings(this)},get_user_from_ViewModel:function(a){var b=this.professionals();for(var c=0,d=b.length;c<d;c++)if(b[c].id()==a)return b[c];return null}},tags_initial_offset=0;viewModel.tagslist=ko.dependentObservable(function(){var a=[];if(this.tags()){var b=this.tags();for(var c=0,d=b.length;c<d;c++)a.push({name:b[c].t||b[c],safe_name:encodeURIComponent(b[c].t||b[c]),counter:b[c].n||""})}return a},viewModel);var loading='<img class=loading alt="loading..." src="/images/menu-loading.gif" />',directory=function(){function d(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return;a.push(b)}function e(a,b,c){$.ajax({type:"POST",url:a,data:b,success:function(b,d){c(null,b.user)},error:function(b,d){var e="";b.status==403?e="Error, session expired of permission denied":e="Error processing request",alert(e),c(e,null)}})}var a={},b={id_cat:1,tag:"",cat:{}},c=[];return a.invalidate_cache=function(a){localStorage.clear()},a.load_profile=function(a,b){$.getJSON("api/users/byid",{id:a},function(a){b(null,a.user)})},a.load_data=function(a,c){function j(d){a.bindusers!==!1&&viewModel.bindprofessionals(d.users),viewModel.logged_user(d.logged_user),d.tags&&a.bindusers!==!1&&viewModel.tags(d.tags),viewModel.cats(d.cats),b=a,b.pagination=d.pagination,d.cat&&(b.cat=d.cat),c&&c(null,d,b)}a||(a={});if(a.id_cat||a.tag)a.search=null;(a.id_cat!=b.id_cat||a.tag!=b.tag)&&!a.from&&(a.from=0);for(var d in b)a[d]===undefined?a[d]=b[d]||"":a[d]===null&&(a[d]="");a.scope=getScope();var e=a.id_cat+"."+a.tag+"."+a.search+"."+a.sort+"."+a.from+"."+JSON.stringify(a.scope).replace('"',""),f=!!window.localStorage,g=!0;if(f&&localStorage.getItem(e)){var h=JSON.parse(localStorage.getItem(e)),i=18e4;h.cache_timestamp&&(new Date).getTime()-h.cache_timestamp<i&&(g=!1,j(h))}g&&$.getJSON(a.search?"/api/search":"/api/users",a,function(a){j(a),f&&(a.cache_timestamp=(new Date).getTime(),localStorage.setItem(e,JSON.stringify(a)))})},a.vote=function(a,b){a.user_voted_id=a.id,e("/vote",a,b)},a.favorite=function(a,b){a.user_fav_id=a.id,a.favstatus=a.favstatus,e("/favorite",a,b)},a.search=function(a,b){this.load_data(a,b)},a}();$(document).ready(function(){tags_initial_offset=$(".tags").offset(),$(document).bind("directory.onChangeSorting",function(a,b){directory.load_data({sort:b},function(a,b,c){$(document).trigger("directory.onProfessionalListChanged",c)})}),$(document).bind("directory.onChangeFilter",function(a,b){directory.load_data({},function(a,b,c){$(document).trigger("directory.onProfessionalListChanged",c)})}),$(document).bind("directory.onProfessionalListChanged",function(a,b){$(".tags").offset({top:tags_initial_offset.top}),scroll(0,0),$("ul#professionals li div.short").show();var c="",d=[];if(b.search)d.push({name:"Search",value:b.search,type:"primary tag"}),c="/search/"+encodeURIComponent(b.search);else{var e="";if(b.cat&&b.cat.id){var f="";$("ul#categories li").removeClass("selected"),$("ul#categories li a").each(function(){$(this).attr("idcat")==b.cat.id&&$(this).parent().addClass("selected")}),e="/categories/"+b.cat.id+"/"+b.cat.name,d.push({name:"Categoría",value:b.cat.name,type:"primary cat"})}c=e,$("ul#tags li").removeClass("selected"),$("ul#tags li a").each(function(){$(this).click(function(){return $.address.value(e+"/tag/"+encodeURIComponent($(this).text())),!1}),$(this).attr("rel","address:"+e+"/tag/"+encodeURIComponent($(this).text())),$(this).attr("href","/directory"+e+"/tag/"+encodeURIComponent($(this).text())),$(this).attr("tag")==b.tag&&$(this).parent().addClass("selected")}),b.tag&&(d.push({name:"Tag",value:b.tag,type:"primary tag"}),c+="/tag/"+encodeURIComponent(b.tag)),$("#searchBox").val("")}var g="";if(b.pagination.total_records){g="<span>Total registros: "+b.pagination.total_records+"</span>";if(b.pagination.total>1){var h=!1,i=4,j=parseInt(b.pagination.from,10);for(var k=0;k<b.pagination.total;k++){k==j+i&&(h=!1);if(k>b.pagination.total-3||k<2||k>j-i&&k<j+i){var l=c+"?p="+k;l=' <a href="/directory'+l+'"'+(b.pagination.from==k?" class=selected ":"")+' rel="address:'+l+'">'+(k+1)+"</a>",g+=l}else h||(g+=" ... ",h=!0)}}}else g="<span>Vaya, no hemos encontrado lo que intentabas buscar... :/ </span>";$("#pagination").html(g),$("#pagination a").each(function(){$(this).click(function(){return $.address.value($(this).attr("rel").replace("address:","")),!1})}),setFilterDisplay(d),$(".sortingOptions").show(),$(".popover").hide()}),$(document).bind("directory.onProfileLoaded",function(a,b){}),$(document).bind("directory.onSearchCompleted",function(a,b){$("ul#categories li, ul#tags li").removeClass("selected")}),$("[rel=popover]").popover({live:!0,html:!0,offset:10}).click(function(a){a.preventDefault()}),$("#sortingSelect").change(function(){$(document).trigger("directory.onChangeSorting",$("#sortingSelect").val())}),$("div.filterBox input").click(function(){$(document).trigger("directory.onChangeFilter")}),$("span.voteBox a.vote").live("click",function(){var a=$(this).attr("idProfile"),b={vote:$(this).attr("vote"),id:a};return directory.vote(b,function(b,c){directory.invalidate_cache();if(!b){var d=viewModel.get_user_from_ViewModel(a);d&&(d.votes(c.votes),d.voted(c.voted))}}),!1}),$("a.fav").live("click",function(){var a=$(this).attr("idProfile"),b={favstatus:$(this).attr("fav"),id:a};return directory.favorite(b,function(b,c){directory.invalidate_cache();if(!b){var d=viewModel.get_user_from_ViewModel(a);d&&d.favorite(c.favorite)}}),!1}),$("a.login").live("click",function(){directory.invalidate_cache(),$(this).html("Redirigiendo a login..."),$(this).attr("href",$(this).attr("href")+"?redirect=/directory#"+$.address.value())}),$("#searchBox").click(function(){$(this).select()}),$("#searchBox").keydown(function(a){if(a.keyCode=="13"||a.keyCode=="32"){var b=document.URL.replace(/^(?:\/\/|[^\/]+)*\//,"");b.indexOf("directory")==0?$.address.value("search/"+$("#searchBox").val()):window.location.href="/directory/#search/"+$("#searchBox").val()}}),directory.invalidate_cache(),$.address.init(function(a){}).change(function(a){set_content_by_hash(a.path,function(){ko.applyBindings(viewModel)})})});